<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MOVIES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #ff6ec7;
      --secondary: #00f5a0;
      --tertiary: #ffd93d;
      --bg: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      --fg: #ffffff;
      --card-bg: rgba(255, 255, 255, 0.07);
      --hover-bg: rgba(255, 255, 255, 0.15);
    }
    html, body { margin:0; padding:0; font-family:'Segoe UI',sans-serif; background:var(--bg); color:var(--fg); min-height:100vh;}
    body { padding:1vh 3vw;}
    .header { text-align:center; margin-bottom:0.8rem;}
    h1 { font-size:1.8rem; margin:0; background:linear-gradient(90deg,var(--primary),var(--secondary),var(--tertiary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:bold;}
    #searchBar { width:100%; padding:0.6rem; font-size:0.9rem; background:var(--card-bg); color:var(--fg); border:1px solid var(--secondary); border-radius:0.5rem; margin-bottom:1rem;}
    .section { margin-bottom:1.2rem;}
    .horizontal-scroll { display:flex; overflow-x:auto; padding:0.5rem; gap:0.6rem;}
    .card-item { flex:0 0 auto; width:110px; height:190px; background:var(--card-bg); border-radius:0.5rem; overflow:hidden; text-align:center; cursor:pointer;}
    .card-item img { width:100%; height:150px; object-fit:cover;}
    .card-item p { margin:0.2rem 0; font-size:0.75rem;}
    #videoContainer { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.95); display:none; justify-content:center; align-items:center; flex-direction:column; z-index:999;}
    #videoPlayer { width:100%; height:100%; background:black;}
    #closeBtn { position:absolute; top:1vh; right:2vw; background:linear-gradient(45deg,var(--primary),var(--secondary)); color:#fff; padding:0.5rem 1rem; border:none; border-radius:0.4rem; cursor:pointer;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
  <div class="header"><h1>MOVIES COLLECTION</h1></div>
  <input type="search" id="searchBar" placeholder="Search..." />
  <div id="channelSections"></div>

  <div id="videoContainer">
    <button id="closeBtn" onclick="closeVideo()">Close</button>
    <video id="videoPlayer" controls autoplay playsinline controlsList="nodownload"></video>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ‚úÖ Your Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAzor9nT1_gnciPId_DinxZQ9teIDwxCKQ",
      authDomain: "movies-collection-c14e5.firebaseapp.com",
      projectId: "movies-collection-c14e5",
      storageBucket: "movies-collection-c14e5.appspot.com",
      messagingSenderId: "21801467048",
      appId: "1:21801467048:web:f31c172c7bf50ef67c969d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const baseUrl = "https://opop.pro/ZG1achkVCQWXz";
    let allChannels = [], filteredChannels = [];

    async function loadM3U() {
      try {
        // Try Firebase first
        const docRef = doc(db, "playlists", "main");
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          console.log("‚úÖ Loaded from Firebase");
          allChannels = docSnap.data().channels;
          filteredChannels = allChannels;
          renderSections(groupChannels(filteredChannels));
          return;
        }
      } catch (err) {
        console.warn("‚ö†Ô∏è Firebase error:", err);
      }

      // If Firebase empty ‚Üí fetch remote
      try {
        console.log("üåç Fetching remote playlist...");
        const res = await fetch(baseUrl);
        const text = await res.text();
        const lines = text.split(/\r?\n/);

        allChannels = [];
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith("#EXTINF")) {
            const title = (lines[i].match(/,(.*)/) || [])[1]?.trim() || "Untitled";
            const logo = (lines[i].match(/tvg-logo="(.*?)"/) || [])[1] || "";
            const group = (lines[i].match(/group-title="(.*?)"/) || [])[1]?.trim() || "Other";
            const streamUrl = lines[i + 1]?.trim();
            if (streamUrl?.startsWith("http")) {
              allChannels.push({ title, logo, streamUrl, group });
            }
          }
        }

        filteredChannels = allChannels;
        renderSections(groupChannels(filteredChannels));

        // Save copy to Firebase for next time
        try {
          await setDoc(doc(db, "playlists", "main"), { channels: allChannels });
          console.log("‚úÖ Cached playlist in Firebase");
        } catch (err) {
          console.warn("‚ö†Ô∏è Failed to write to Firebase:", err);
        }

      } catch (err) {
        document.getElementById("channelSections").innerHTML =
          "<p style='color:red;'>‚ùå Failed to load playlist.</p>";
        console.error(err);
      }
    }

    function groupChannels(channels) {
      const grouped = {};
      channels.forEach(ch => {
        if (!grouped[ch.group]) grouped[ch.group] = [];
        grouped[ch.group].push(ch);
      });
      return grouped;
    }

    function renderSections(grouped) {
      const container = document.getElementById("channelSections");
      container.innerHTML = "";
      Object.entries(grouped).forEach(([groupName, channels]) => {
        const section = document.createElement("div");
        section.className = "section";
        const title = document.createElement("h2");
        title.textContent = groupName;
        section.appendChild(title);
        const scroll = document.createElement("div");
        scroll.className = "horizontal-scroll";
        channels.forEach(ch => {
          const card = document.createElement("div");
          card.className = "card-item";
          card.setAttribute("tabindex", "0");
          card.innerHTML = `
            <img src="${ch.logo || "https://via.placeholder.com/100x150"}" alt="${ch.title}">
            <p>${ch.title}</p>
          `;
          card.onclick = () => playChannel(ch.streamUrl);
          scroll.appendChild(card);
        });
        section.appendChild(scroll);
        container.appendChild(section);
      });
    }

    function playChannel(url) {
      const container = document.getElementById("videoContainer");
      const video = document.getElementById("videoPlayer");
      container.style.display = "flex";
      video.pause();
      video.src = "";
      if (Hls.isSupported() && url.endsWith(".m3u8")) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
      } else {
        video.src = url;
        video.play();
      }
    }

    function closeVideo() {
      const container = document.getElementById("videoContainer");
      const video = document.getElementById("videoPlayer");
      video.pause(); video.src = "";
      container.style.display = "none";
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && document.activeElement.classList.contains("card-item")) {
        document.activeElement.click();
      }
      if (e.key === "Backspace" || e.key === "Escape") {
        closeVideo();
      }
    });

    document.getElementById("searchBar").addEventListener("input", function () {
      const query = this.value.toLowerCase();
      filteredChannels = allChannels.filter(ch => ch.title.toLowerCase().includes(query));
      renderSections(groupChannels(filteredChannels));
      document.querySelector(".card-item")?.focus();
    });

    window.onload = loadM3U;
  </script>
</body>
</html>
